% Eli Bowen 2/27/2020
% wrapper around the rastamat library MFCC functionality (https://labrosa.ee.columbia.edu/matlab/rastamat/)
% USAGE:
%   [data,Fs] = audioread(fullfile('D:', 'datasets/audio/Harry_Potter_and_the_Chamber_of_Secrets-English/001_harry_potter_and_the_chamber_of_secrets_US_ch_001_the_worst_birthday-96k.wav'));
%   data = MFCC(data, Fs, 2*128, 128);
% INPUT:
%	data     - PCM audio vector
%	fs       - scalar (int-valued numeric) sampling rate of the audio
%	windowSz - scalar (int-valued numeric) size of temporal window in units of number of SAMPLES (not ms)
%	stepSz   - scalar (int-valued numeric) size of temporal step in units of number of SAMPLES (not ms)
% RETURNS:
%   data - n_steps x 60 double
function data = MFCC(data, fs, windowSz, stepSz)
    validateattributes(data,     {'numeric'}, {'nonempty','vector'}, 1);
    validateattributes(fs,       {'numeric'}, {'nonempty','scalar','positive','integer'}, 2);
    validateattributes(windowSz, {'numeric'}, {'nonempty','scalar','positive','integer'}, 3);
    validateattributes(stepSz,   {'numeric'}, {'nonempty','scalar','positive','integer'}, 4);

    % convert to MFCCs very close to those generated by feacalc -sr 22050 -nyq 8000 -dith -hpf -opf htk -delta 0 -plp no -dom cep -com yes -frq mel -filt tri -win 32 -step 16 -cep 20
    data = data .* 3.3752;
    data = melfcc(data, fs, 'maxfreq', 8000, 'numcep', 20, 'nbands', 22, 'fbtype', 'fcmel', 'dcttype', 1, 'usecmp', 1, 'wintime', windowSz/Fs, 'hoptime', stepSz/Fs, 'preemph', 0, 'dither', 1);
    del = deltas(data);
    ddel = deltas(deltas(data, 5), 5); % double deltas are deltas applied twice with a shorter window
    data = [data;del;ddel]; % composite, 60-element feature vector
    data = data';
end